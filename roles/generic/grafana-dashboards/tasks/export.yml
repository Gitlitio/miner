- name: fetch grafana dashboards
  uri:
    url: "{{ grafana_url }}/api/dashboards/db/{{ dashboard_name_slug_map[item.name] }}"
    method: GET
    headers:
      Authorization: "Bearer {{ grafana_api_key }}"
    status_code: 200
  with_items: "{{ grafana_dashboards }}"
  no_log: yes
  when:
    - item.state|default('present') == 'present'
    - item.name in dashboard_name_slug_map|default({})
  register: fetched_dashboards

- name: create dashboards dir
  local_action:
    module: file
    path: "{{ grafana_dashboards_dir }}"
    state: directory

- name: save fetched grafana dashboards
  local_action:
    module: copy
    content: "{{ item.json.dashboard | to_nice_json }}"
    dest: "{{ grafana_dashboards_dir + '/' + item.item.filename }}"
  with_items: "{{ fetched_dashboards.results }}"
  no_log: yes
  when:
    - not item.skipped|default(false)
