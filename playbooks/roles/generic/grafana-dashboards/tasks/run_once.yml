- name: get grafana dashboard uids
  uri:
    url: "{{ grafana_url|mandatory }}/api/search"
    method: GET
    headers:
      Authorization: "Bearer {{ grafana_api_key|mandatory }}"
    status_code: 200
  no_log: yes
  register: dashboard_results

- name: map dashboard names to uids
  set_fact:
    dashboard_name_uid_map: "{{ dashboard_name_uid_map|default({}) | combine( {item.title: item.uid} ) }}"
  with_items: "{{ dashboard_results.json }}"

- import_tasks: export.yml
  when: grafana_dashboards_export|bool

- import_tasks: crud.yml
  when: not grafana_dashboards_export|bool
